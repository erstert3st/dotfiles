---
- name: Ping all hosts
  ansible.builtin.ping:
    data: "Hello, World! @install-debian.yml"

- name: Ensure latest updates @ Debian-based systems
  ansible.builtin.apt:
    state: present
    update_cache: true
    upgrade: full
    autoremove: true
    autoclean: true
  become: true
#TODO add keys to apt repositories ! # check on other :) 
# - name: Download and add the Helm signing key
#   ansible.builtin.shell: |
#     curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | tee /usr/share/keyrings/helm.gpg > /dev/null
#   args:
#     creates: /usr/share/keyrings/helm.gpg

- name: Install http things
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - curl
      - gpg
      - gnupg2
      - apt-utils
    state: present

- name: Add Helm signing key
  ansible.builtin.apt_key:
    url: https://baltocdn.com/helm/signing.asc
    state: present
  become: true

- name: Add Helm repository to APT sources list
  ansible.builtin.apt_repository:
    repo: "deb [arch=arm64] https://baltocdn.com/helm/stable/debian/ all main"
    state: present
    filename: helm-stable
    update_cache: true
  become: true

- name: Check if helm is installed
  ansible.builtin.command:
    cmd: helm version --short
  register: helm_check
  ignore_errors: true

- name: Download k9s .deb package
  ansible.builtin.get_url:
    url: https://github.com/derailed/k9s/releases/latest/download/k9s_linux_arm64.deb
    dest: /tmp/k9s_linux_arm64.deb
  when: helm_check.rc != 0

- name: Install k9s package
  ansible.builtin.apt:
    deb: /tmp/k9s_linux_arm64.deb
    state: present
  when: helm_check.rc != 0
- name: Remove the k9s .deb file after installation
  ansible.builtin.file:
    path: /tmp/k9s_linux_arm64.deb
    state: absent
  when: helm_check.rc != 0

- name: Add Kubernetes keyring key to apt
  ansible.builtin.apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key
    state: present

- name: Add Kubernetes repository to apt
  ansible.builtin.apt_repository:
    repo: 'deb https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /'
    filename: kubernetes
    update_cache: true
    state: present
